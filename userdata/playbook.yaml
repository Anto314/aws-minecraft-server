---
- hosts: localhost
  tasks:
    - name: Loading Configuration File
      include_vars:
        file: conf.yaml
    - name: Install Java
      package:
        name: "{{item}}"
      with_items:
        - "java-{{java_version}}"
        - tmux
        - htop
        - awscli
    - name: Create Folder
      file:
        state: directory
        path: "{{minecraft.installation_path}}"
        recurse: yes
    - name: Fabric
      get_url:
        url: "{{fabric_url}}"
        dest: ./fabric.jar
        mode: '0755'

    - name: Copy Configuration File
      copy:
        src: "{{item}}"
        dest: "{{minecraft.installation_path}}/{{item}}"
      with_items:
        - eula.txt
        - server.properties
        - minecraft_lib.sh
    - name: Generate Environment File
      template:
        src: minecraft.env.j2
        dest: "{{minecraft.installation_path}}/minecraft.env"

    - name: Install Scripts
      copy:
        src: "{{item}}"
        dest: "{{minecraft.installation_path}}"
        mode: 0755
      with_items:
        - stopServer.sh

    - name: Run Fabric Installation
      shell: "java -jar ./fabric.jar server -dir {{minecraft.installation_path}} -mcversion {{minecraft.version}} -downloadMinecraft"

    - name: Retrieve Previous Minecraft Server State
      block:
        - name: Get World Backup
          amazon.aws.aws_s3:
            bucket: s3-anto-minecraft-server
            object: world.zip
            dest: "{{minecraft.installation_path}}/world.zip"
            mode: get
        - name: Unzip the world
          unarchive:
            src: "{{minecraft.installation_path}}/world.zip"
            dest: "/"
      rescue:
        - name: No Previous Minecraft Server State
          ansible.builtin.debug:
            msg: "There is no world, let minecraft to create one"

    - name: Generate the systemd service specification
      template:
        src: minecraft.service.j2
        dest: /etc/systemd/system/minecraft.service

    - name: Start the Service
      systemd:
        name: minecraft
        state: started

    - name: Wait That server is ready for players
      block:
        - name: Wait the server to start and load the map
          wait_for:
            path: "{{minecraft.installation_path}}/logs/latest.log"
            search_regex: "Done"
        - name: Get Public IP of Server
          uri:
            url: http://169.254.169.254/latest/meta-data/public-ipv4
            method: GET
            status_code: [200, 202]
            return_content: true
          register: public_ip
        - name: Notify users that the server is ready
          community.aws.sns:
            msg: "{{lookup('template', 'sns.success.j2')}}"
            subject: Server Minecraft est pret!
            topic: sns-cf-minecraft-server
            region: eu-west-1